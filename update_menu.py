import os
import re

# ==========================================
# è¨­å®šã‚¨ãƒªã‚¢
# ==========================================
OUTPUT_FILE = "js/menu.js"

# ãƒ•ã‚©ãƒ«ãƒ€ã¨IDã®å¯¾å¿œ
TARGET_DIRS = {
    "english": "english",
    "math": "math",
    "japanese": "japanese",
    "science": "science",
    "social": "social",
    "info": "info"
}

# ==========================================
# å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
# ==========================================

def get_html_title(file_path):
    """HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰<title>ã‚¿ã‚°ã®ä¸­èº«ã‚’æŠ½å‡ºã™ã‚‹"""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
            match = re.search(r'<title>(.*?)</title>', content, re.IGNORECASE | re.DOTALL)
            if match:
                return match.group(1).strip()
    except Exception as e:
        print(f"Error reading {file_path}: {e}")
    return "No Title"

def generate_menu_js():
    menu_data = []
    print("--- Scanning directories (Nested Structure) ---")

    for folder, subject_id in TARGET_DIRS.items():
        if not os.path.exists(folder):
            continue

        # 1. æ•™ç§‘ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­èº«ã‚’èµ°æŸ»
        for item in os.listdir(folder):
            item_path = os.path.join(folder, item)

            # 2. ãã‚ŒãŒã€Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆå˜å…ƒãƒ•ã‚©ãƒ«ãƒ€ï¼‰ã€ã§ã‚ã‚‹ã‹ç¢ºèª
            if os.path.isdir(item_path):
                # 3. ãã®ä¸­ã« 'index.html' ãŒã‚ã‚‹ã‹ç¢ºèª
                html_path = os.path.join(item_path, "index.html")
                
                if os.path.exists(html_path):
                    # ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
                    title = get_html_title(html_path)
                    
                    # Webç”¨ãƒ‘ã‚¹ã«å¤‰æ› (Windowsã®ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥å¯¾ç­–)
                    web_path = html_path.replace(os.sep, '/')
                    
                    print(f"Found: [{subject_id}] {title} -> {web_path}")
                    
                    menu_data.append({
                        "id": subject_id,
                        "title": title,
                        "file": web_path
                    })

    # JSãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãå‡ºã—
    js_content = f"""/* js/menu.js - Auto-generated by Python */

// æ•™ç§‘ã”ã¨ã®è¨­å®š
const subjectSettings = {{
    english: {{ name: "English", icon: "A", colorClass: "subject-english", description: "å˜èªãƒ»é•·æ–‡" }},
    math:    {{ name: "Math",     icon: "âˆ‘", colorClass: "subject-math",    description: "æ•°å­¦Iãƒ»Aãƒ»IIãƒ»B" }},
    kokugo:  {{ name: "å›½èª",      icon: "æ–‡", colorClass: "subject-kokugo",  description: "ç¾ä»£æ–‡ãƒ»å¤æ–‡ãƒ»æ¼¢æ–‡" }},
    science: {{ name: "Science",  icon: "ğŸ§ª", colorClass: "subject-science", description: "ç‰©ç†ãƒ»åŒ–å­¦ãƒ»åœ°å­¦" }},
    social:  {{ name: "Social",   icon: "ğŸ›ï¸", colorClass: "subject-social",  description: "æ­´å²ãƒ»åœ°ç†" }},
    info:    {{ name: "Info",     icon: "ğŸ’»", colorClass: "subject-info",    description: "æƒ…å ±ãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°" }}
}};

// è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆ
const menuData = {str(menu_data).replace("'", '"')};
"""

    try:
        with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
            f.write(js_content)
        print(f"\nSuccessfully updated {OUTPUT_FILE}!")
    except Exception as e:
        print(f"Error writing file: {e}")

if __name__ == "__main__":
    generate_menu_js()