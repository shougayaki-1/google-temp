import os
import re

# ==========================================
# è¨­å®šã‚¨ãƒªã‚¢
# ==========================================
OUTPUT_FILE = "js/menu.js"

TARGET_DIRS = {
    "english": "english",
    "math": "math",
    "japanese": "japanese",
    "science": "science",
    "social": "social",
    "info": "info"
}

# â˜…ä¿®æ­£ç®‡æ‰€: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾å¿œã™ã‚‹ã€Œè¡¨ç¤ºåã€ã¨ã€Œã‚¢ã‚¤ã‚³ãƒ³ã€ã‚’è¨­å®š
SUB_CATEGORY_RULES = {
    # ç†ç§‘
    "chemistry":     {"label": "Chemistry",     "icon": "ğŸ§ª"}, # è©¦é¨“ç®¡
    "earth_science": {"label": "Earth Science", "icon": "ğŸŒ"}, # åœ°çƒ
    "biology":       {"label": "Biology",       "icon": "ğŸ§¬"}, # DNA
    "physics":       {"label": "Physics",       "icon": "âš¡"}, # é›·
    
    # å›½èª
    "kanbun":        {"label": "æ¼¢æ–‡",          "icon": "æ¼¢"}, # æ¼¢å­—ã®ã€Œæ¼¢ã€
    "kobun":         {"label": "å¤æ–‡",          "icon": "å¤"}, # æ¼¢å­—ã®ã€Œå¤ã€
    "gendai":        {"label": "ç¾ä»£æ–‡",        "icon": "ç¾"}, 
    
    # æ•°å­¦
    "vector":        {"label": "Vector",        "icon": "â†—ï¸"}, 
    "calulus":       {"label": "Calculus",      "icon": "âˆ«"},  
    
    # è‹±èª
    "word":          {"label": "Vocabulary",    "icon": "å˜"},
    "reading":       {"label": "Reading",       "icon": "èª­"},
}

# ==========================================
# å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
# ==========================================

def get_html_title(file_path):
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
            match = re.search(r'<title>(.*?)</title>', content, re.IGNORECASE | re.DOTALL)
            if match:
                return match.group(1).strip()
    except Exception as e:
        print(f"Error reading {file_path}: {e}")
    return "No Title"

def get_category_info(file_path):
    """ãƒ‘ã‚¹ã‹ã‚‰è©³ç´°ãªã‚«ãƒ†ã‚´ãƒªåã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—ã™ã‚‹"""
    lower_path = file_path.lower()
    
    for key, info in SUB_CATEGORY_RULES.items():
        if key in lower_path:
            return info # {"label": "...", "icon": "..."} ã‚’è¿”ã™
    
    return None

def generate_menu_js():
    menu_data = []
    print("--- Scanning directories ---")

    for folder, subject_id in TARGET_DIRS.items():
        if not os.path.exists(folder):
            continue

        # æ—¥ä»˜é †ï¼ˆæ–°ã—ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
        for item in sorted(os.listdir(folder), reverse=True):
            item_path = os.path.join(folder, item)

            if os.path.isdir(item_path):
                html_path = os.path.join(item_path, "index.html")
                
                if os.path.exists(html_path):
                    title = get_html_title(html_path)
                    web_path = html_path.replace(os.sep, '/')
                    
                    # â˜…ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ï¼ˆåå‰ã¨ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‚’å–å¾—
                    cat_info = get_category_info(web_path)

                    print(f"Found: [{subject_id}] {title}")
                    
                    data = {
                        "id": subject_id,
                        "title": title,
                        "file": web_path
                    }
                    
                    # è©³ç´°æƒ…å ±ãŒã‚ã‚Œã°ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
                    if cat_info:
                        data["category"] = cat_info["label"]
                        data["icon"] = cat_info["icon"]  # â˜…ã‚¢ã‚¤ã‚³ãƒ³ã‚‚è¿½åŠ 

                    menu_data.append(data)

    js_content = f"""/* js/menu.js - Auto-generated by Python */

const subjectSettings = {{
    english: {{ name: "English", icon: "A", colorClass: "subject-english", description: "å˜èªãƒ»é•·æ–‡" }},
    math:    {{ name: "Math",     icon: "âˆ‘", colorClass: "subject-math",    description: "æ•°å­¦" }},
    japanese:{{ name: "Japanese", icon: "æ–‡", colorClass: "subject-kokugo",  description: "ç¾ä»£æ–‡ãƒ»å¤æ–‡ãƒ»æ¼¢æ–‡" }},
    science: {{ name: "Science",  icon: "ğŸ§ª", colorClass: "subject-science", description: "ç‰©ç†ãƒ»åŒ–å­¦ãƒ»åœ°å­¦ãƒ»ç”Ÿç‰©" }},
    social:  {{ name: "Social",   icon: "ğŸ›ï¸", colorClass: "subject-social",  description: "æ­´å²ãƒ»åœ°ç†" }},
    info:    {{ name: "Info",     icon: "ğŸ’»", colorClass: "subject-info",    description: "æƒ…å ±" }}
}};

const menuData = {str(menu_data).replace("'", '"').replace("None", "null")};
"""

    try:
        with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
            f.write(js_content)
        print(f"\nSuccessfully updated {OUTPUT_FILE}!")
    except Exception as e:
        print(f"Error writing file: {e}")

if __name__ == "__main__":
    generate_menu_js()